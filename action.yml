name: "Jenkins-Action"
description: "Start Jenkins jobs and report back URL and status of build"
author: "Coupa Software"
inputs:
  aws_access_key_id:
    description: "AWS Access Key ID"
    required: true
  aws_secret_access_key:
    description: "AWS Secret Access Key"
    required: true
  url:
    description: "Jenkins URL including http/https protocol"
    required: true
  job_name:
    description: "Jenkins job name to build"
    required: true
  username:
    description: "Jenkins username"
    required: false
  api_token:
    description: "Jenkins API token"
    required: false
  parameters:
    description: 'Build parameters in JSON format e.g. `{"field1":"value1"}`'
    required: false
  cookies:
    description: 'Cookies to include in HTTP requests in JSON format e.g. `{"field1":"value1"}`'
    required: false
  wait:
    description: "Should the runner wait for the build to finish and provide ok status"
    required: false
    default: "True"
  timeout:
    description: "Timeout in seconds for build to complete"
    required: false
    default: "600"
  start_timeout:
    description: "Timeout in seconds for build to start"
    required: false
    default: "600"
  interval:
    description: "How frequently in seconds to query Jenkins for build status"
    required: false
    default: "5"
outputs:
  build_url:
    description: "Jenkins build URL"

runs:
  using: "composite"
  steps:
    - name: Run jenkins-githubaction
      shell: bash
      env:
        AWS_ACCESS_KEY_ID: ${{ inputs.aws_access_key_id }}
        AWS_SECRET_ACCESS_KEY: ${{ inputs.aws_secret_access_key }}
        AWS_REGION: us-east-1
        ECR_REPO: "899991151204.dkr.ecr.us-east-1.amazonaws.com"
        DOCKER_IMAGE: "jenkins-githubaction:v1.0.1"
        INPUT_URL: ${{ inputs.url }}
        INPUT_JOB_NAME: ${{ inputs.job_name }}
        INPUT_USERNAME: ${{ inputs.username }}
        INPUT_API_TOKEN: ${{ inputs.api_token }}
        INPUT_PARAMETERS: ${{ inputs.parameters }}
        INPUT_COOKIES: ${{ inputs.cookies }}
        INPUT_WAIT: ${{ inputs.wait }}
        INPUT_TIMEOUT: ${{ inputs.timeout }}
        INPUT_START_TIMEOUT: ${{ inputs.start_timeout }}
        INPUT_INTERVAL: ${{ inputs.interval }}
      run: |
        echo "1"
        aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $ECR_REPO
        echo "2"
        docker pull $ECR_REPO:$DOCKER_IMAGE
        echo "3"
        docker run --env INPUT_AWS_ACCESS_KEY_ID --env INPUT_AWS_SECRET_ACCESS_KEY --env INPUT_URL --env INPUT_JOB_NAME --env INPUT_USERNAME --env INPUT_API_TOKEN --env INPUT_PARAMETERS --env INPUT_COOKIES --env INPUT_WAIT --env INPUT_TIMEOUT --env INPUT_START_TIMEOUT --env INPUT_INTERVAL $ECR_REPO:$DOCKER_IMAGE
